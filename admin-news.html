<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Actualit√©s Smart Wise</title>
    <link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg" />
    <link rel="shortcut icon" href="/images/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" />
    <link rel="manifest" href="/images/site.webmanifest" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="news-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
       
    </style>
</head>

<body>

    <!-- 1. Barre de navigation et d√©connexion -->
    <div class="logout-bar">
        <div class="nav-links">
            <!-- Bouton pour aller vers l'autre page admin -->
            <a href="admin-projects.html" class="nav-link-btn">üìÅ G√©rer les Projets</a>
        </div>
        <div class="user-info">
            <div class="user-profile-box">
                <img id="userAvatar" src="" alt="" style="display:none;">
                <div class="user-details">
                    <span id="userName">Chargement...</span>
                    <span id="userRole" class="role-badge">√âditeur</span>
                </div>
            </div>
            <button id="btnManageAccounts" onclick="openAccountModal()" class="accounts-btn" style="display:none;">
                üë• Comptes
            </button>
            <button onclick="logout()" class="logout-btn">D√©connexion üö™</button>
        </div>
    </div>
    <div id="adminContent">

        <div class="main-wrapper">
            <!-- FORMULAIRE -->
            <div class="card">
                <!-- EN-T√äTE DU FORMULAIRE -->
                <div class="header-container">
                    <!-- Remplacez l'URL ci-dessous par le lien de votre logo -->
                    <img src="/images/SMARTWISE_LOGO_FINAL_24_Septembre_2025.svg" alt="Logo Smart Wise"
                        class="header-logo">

                    <h1 id="formTitle">Publier une Actualit√©</h1>
                </div>
                <!-- CONFIGURATION -->
                <div class="form-grid">
                    <div>
                        <label>Date de publication</label>
                        <input type="date" id="date">
                    </div>
                    <div>
                        <label>Cat√©gorie</label>
                        <select id="category" class="form-input" required>
                            <option value="Produits & Services">Produits & Services</option>
                            <option value="Entreprise">Entreprise</option>
                            <option value="Technologie">Technologie</option>
                            <option value="Info Pratique">Info Pratique</option>
                            <option value="Impact">Impact</option>
                            <option value="√âv√©nement">√âv√©nement</option>
                            <!-- Toujours utile de garder celui-l√† √† part -->
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Image de couverture</label>
                    <div class="image-upload-wrapper">
                        <div class="upload-area" id="uploadArea">
                            <div id="uploadPlaceholder">
                                <div class="upload-icon">‚òÅÔ∏è</div>
                                <div class="upload-text">
                                    <span>Cliquez ici</span> pour ajouter une image
                                    <br><small style="opacity:0.7">JPG, PNG, WEBP (Max 2MB)</small>
                                </div>
                            </div>
                            <img id="currentImagePreview" alt="Aper√ßu">
                        </div>
                        <input type="file" id="imageFile" accept="image/*">
                    </div>
                </div>

                <!-- CONTENU FRAN√áAIS -->
                <div class="form-group">
                    <label>Titre (FR) *</label>
                    <input type="text" id="title_fr" placeholder="Ex: Lancement de la nouvelle version">
                </div>

                <div class="form-group">
                    <label>R√©sum√© court (FR)</label>
                    <textarea id="summary_fr" rows="2" placeholder="Une phrase d'accroche..."></textarea>
                </div>

                <div class="form-group">
                    <label>Contenu de l'article (FR) *</label>
                    <textarea id="content_fr" rows="6"
                        placeholder="<p>Le contenu complet de votre article...</p>"></textarea>
                </div>

                <!-- CONTENU ANGLAIS -->
                <!-- CONTENU ANGLAIS CORRIG√â -->
                <div class="en-section">

                    <!-- On utilise form-group (pleine largeur) au lieu de form-grid -->
                    <div class="form-group">
                        <label class="label-en">Title (EN)</label>
                        <input type="text" id="title_en" placeholder="Optional translation">
                    </div>

                    <div class="form-group">
                        <label class="label-en">Short Summary (EN)</label>
                        <textarea id="summary_en" rows="2" placeholder="Optional summary"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="label-en">Article Content (EN)</label>
                        <textarea id="content_en" rows="6" placeholder="Optional content"></textarea>
                    </div>
                </div>

                <div class="btn-group">
                    <button id="btnCancel" class="btn">
                        <span>Annuler</span>
                    </button>
                    <button id="btnSave" class="btn">
                        <span>üöÄ Publier l'article</span>
                    </button>
                </div>

                <div id="status"></div>
            </div>

            <!-- LISTE -->
            <div class="card">
                <h2>Articles en ligne</h2>
                <div id="newsList" class="news-list-container">
                    <p style="color:#94a3b8; text-align:center;">Chargement des articles...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Avatar style "WhatsApp" -->
    <div id="avatarModal" class="modal-overlay" style="display:none;">
        <div class="modal-card">
            <div class="modal-header">
                <h3>Photo de profil</h3>
                <span class="close-modal" onclick="closeAvatarModal()">&times;</span>
            </div>

            <div class="modal-body">
                <div class="img-container">
                    <img id="modalAvatarPreview" src="" alt="Aper√ßu">
                </div>
            </div>

            <div class="modal-footer">
                <button class="modal-btn upload-btn" onclick="triggerFileInput()">
                    <span>üì∑</span> Modifier
                </button>
                <button class="modal-btn delete-btn-modal" onclick="deleteAvatar()">
                    <span>üóëÔ∏è</span> Supprimer
                </button>
            </div>
        </div>
        <!-- Input invisible pour choisir le fichier -->
        <input type="file" id="avatarInputHidden" accept="image/*" style="display:none;" onchange="uploadAvatar(this)">
    </div>

    <!-- MODALE GESTION COMPTES -->
    <div id="accountModal" class="modal-overlay" style="display:none;">
        <div class="modal-card" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Gestion des Acc√®s</h3>
                <span class="close-modal" onclick="closeAccountModal()">&times;</span>
            </div>

            <div class="modal-body" style="padding: 20px; background: #fff; min-height: auto;">

                <!-- MENU PRINCIPAL (2 BOUTONS) -->
                <div id="accMenu" style="display:flex; gap:15px; justify-content:center; padding: 20px 0;">
                    <button onclick="showAddUser()" class="btn" style="background:var(--primary);">
                        ‚ûï Ajouter un compte
                    </button>
                    <button onclick="showDeleteUser()" class="btn"
                        style="background: #fef2f2; color: var(--danger); border: 1px solid var(--danger);">
                        üóëÔ∏è Supprimer / Lister
                    </button>
                </div>

                <!-- FORMULAIRE AJOUT (Cach√© par d√©faut) -->
                <div id="accAddForm" class="hidden">
                    <h4 style="margin-top:0;">Cr√©er un nouvel utilisateur</h4>
                    <div class="form-group">
                        <label>Nom d'utilisateur</label>
                        <input type="text" id="newUsername" placeholder="Ex: JeanDupont">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="text" id="newEmail" placeholder="email@smartwise.com">
                    </div>
                    <div class="form-group">
                        <label>Mot de passe provisoire</label>
                        <input type="text" id="newPass" placeholder="Min. 6 caract√®res">
                    </div>
                    <div class="form-group">
                        <label>R√¥le</label>
                        <select id="newRole">
                            <option value="editeur">√âditeur</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button onclick="resetAccView()" class="btn" style="background:#94a3b8;">Retour</button>
                        <button onclick="createUser()" class="btn" style="background:var(--primary);">Cr√©er</button>
                    </div>
                </div>

                <!-- LISTE SUPPRESSION (Cach√© par d√©faut) -->
                <div id="accListPanel" class="hidden">
                    <h4 style="margin-top:0;">Utilisateurs actifs</h4>
                    <div id="usersListContainer"
                        style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;">
                        <!-- La liste sera inject√©e ici par JS -->
                    </div>
                    <div class="btn-group">
                        <button onclick="resetAccView()" class="btn" style="background:#94a3b8;">Retour</button>
                    </div>
                    <p style="font-size:0.75rem; color:orange; margin-top:10px;">
                        ‚ö†Ô∏è Note : La suppression ici retire le profil. Pour bloquer d√©finitivement l'acc√®s,
                        supprimez aussi l'utilisateur dans le tableau de bord Supabase.
                    </p>
                </div>

            </div>
        </div>
    </div>


    <script>
        // ==========================================
        // 1. CONFIGURATION SUPABASE
        // ==========================================
        const SUPABASE_URL = 'https://neensjugjhkvwcqslicr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lZW5zanVnamhrdndjcXNsaWNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5Mjg1NzQsImV4cCI6MjA4MTUwNDU3NH0.eDEhhT8HzetCntUZ2LYkZhtoUjSjmFxPQqm03aAL8tU';

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ==========================================
        // 2. GESTION DE LA MODALE AVATAR AVEC AJUSTEMENT
        // ==========================================

        let cropper; // Variable globale pour l'outil de recadrage
        const modalPreview = document.getElementById('modalAvatarPreview');
        const uploadBtn = document.querySelector('.upload-btn');

        // 1. Ouvrir la modale
        document.querySelector('.user-profile-box').onclick = function () {
            const currentSrc = document.getElementById('userAvatar').src;
            modalPreview.src = currentSrc;
            document.getElementById('avatarModal').style.display = 'flex';
        };

        // 2. Fermer la modale et nettoyer
        function closeAvatarModal() {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            document.getElementById('avatarModal').style.display = 'none';
            // Remettre le bouton dans son √©tat initial
            uploadBtn.innerHTML = "<span>üì∑</span> Modifier";
            uploadBtn.onclick = triggerFileInput;
        }

        // 3. D√©clencher le choix de fichier
        function triggerFileInput() {
            document.getElementById('avatarInputHidden').click();
        }

        // 4. Charger l'image dans l'outil d'ajustement (Lanc√© apr√®s choix du fichier)
        async function uploadAvatar(input) {
            if (!input.files || input.files.length === 0) return;

            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                // 1. On affecte la source
                modalPreview.src = e.target.result;

                // 2. On attend que l'image soit charg√©e dans le DOM pour lancer Cropper
                modalPreview.onload = function () {
                    // D√©truire l'ancien cropper s'il existe
                    if (cropper) {
                        cropper.destroy();
                    }

                    // Initialiser Cropper.js
                    cropper = new Cropper(modalPreview, {
                        aspectRatio: 1,
                        viewMode: 1, // Restreint la bo√Æte de recadrage √† l'int√©rieur du canvas
                        dragMode: 'move',
                        autoCropArea: 0.8,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                        ready() {
                            console.log("Cropper est pr√™t");
                            // Transformer le bouton
                            uploadBtn.innerHTML = "<span>‚úÖ</span> Valider ce cadrage";
                            uploadBtn.onclick = confirmCrop;
                        }
                    });
                };
            };
            reader.readAsDataURL(file);
        }

        // 5. Envoyer l'image recadr√©e sur Supabase
        async function confirmCrop() {
            if (!cropper) return;

            // R√©cup√©rer le canvas de l'image recadr√©e (400x400px pour un bon ratio qualit√©/poids)
            cropper.getCroppedCanvas({ width: 400, height: 400 }).toBlob(async (blob) => {
                try {
                    uploadBtn.innerText = "Chargement...";
                    uploadBtn.disabled = true;

                    const { data: { session } } = await supabaseClient.auth.getSession();
                    const userId = session.user.id;

                    // Nom de fichier unique pour √©viter le cache navigateur
                    const fileName = `${userId}/${Date.now()}.png`;

                    // A. Upload vers le bucket 'avatars'
                    const { error: uploadError } = await supabaseClient.storage
                        .from('avatars')
                        .upload(fileName, blob, { contentType: 'image/png', upsert: true });

                    if (uploadError) throw uploadError;

                    // B. R√©cup√©rer l'URL publique
                    const { data: urlData } = supabaseClient.storage.from('avatars').getPublicUrl(fileName);
                    const publicUrl = urlData.publicUrl;

                    // C. Mettre √† jour la table 'profiles'
                    const { error: dbError } = await supabaseClient
                        .from('profiles')
                        .update({ avatar_url: publicUrl })
                        .eq('id', userId);

                    if (dbError) throw dbError;

                    // D. Mise √† jour de l'interface en temps r√©el
                    document.getElementById('userAvatar').src = publicUrl;
                    alert("Photo de profil mise √† jour !");
                    closeAvatarModal();

                } catch (error) {
                    alert("Erreur lors de l'enregistrement : " + error.message);
                } finally {
                    uploadBtn.disabled = false;
                }
            }, 'image/png');
        }

        // 6. Supprimer l'avatar (Retour aux initiales)
        async function deleteAvatar() {
            if (!confirm("Supprimer votre photo de profil ?")) return;

            const { data: { session } } = await supabaseClient.auth.getSession();
            const userId = session.user.id;

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ avatar_url: null })
                    .eq('id', userId);

                if (error) throw error;

                // Remettre l'avatar par d√©faut via l'API ui-avatars
                const name = document.getElementById('userName').innerText;
                const defaultAvatar = `https://ui-avatars.com/api/?name=${name}&background=4e7994&color=fff`;

                document.getElementById('userAvatar').src = defaultAvatar;
                alert("Photo supprim√©e.");
                closeAvatarModal();

            } catch (error) {
                alert("Erreur : " + error.message);
            }
        }

        // Fermer la modale si on clique √† c√¥t√©
        window.onclick = function (event) {
            const modal = document.getElementById('avatarModal');
            if (event.target == modal) closeAvatarModal();
        }

        // ==========================================
        // 3. AUTHENTIFICATION ET PROFIL
        // ==========================================
        async function checkUser() {
            // 1. V√©rification de la session
            const { data: { session } } = await supabaseClient.auth.getSession();

            if (!session) {
                window.location.href = 'index.html';
                return;
            }

            try {
                // 2. R√©cup√©ration du profil
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('display_name, avatar_url, role')
                    .eq('id', session.user.id)
                    .single();

                if (error) throw error;

                // 3. Affichage du contenu
                document.getElementById('adminContent').style.display = 'block';

                const nameDisplay = document.getElementById('userName');
                const avatarDisplay = document.getElementById('userAvatar');
                const roleDisplay = document.getElementById('userRole');

                nameDisplay.innerText = profile.display_name || session.user.email;
                const userRole = profile.role || "editeur";
                if (roleDisplay) roleDisplay.innerText = userRole.toUpperCase();

                if (profile.avatar_url) {
                    avatarDisplay.src = profile.avatar_url;
                } else {
                    avatarDisplay.src = `https://ui-avatars.com/api/?name=${profile.display_name || 'Admin'}&background=4e7994&color=fff`;
                }
                avatarDisplay.style.display = 'block';

                if (userRole === 'admin' || userRole === 'administrator') {
                    const btnAccounts = document.getElementById('btnManageAccounts');
                    if (btnAccounts) btnAccounts.style.display = 'inline-block';
                }

                // --- CORRECTION ICI : loadProjects() devient loadNews() ---
                loadNews();

            } catch (err) {
                console.error("Erreur profil:", err);
                document.getElementById('userName').innerText = session.user.email;
                document.getElementById('adminContent').style.display = 'block';

                // --- CORRECTION ICI AUSSI ---
                loadNews();
            }
        }

        async function logout() {
            const { error } = await supabaseClient.auth.signOut();
            if (error) alert("Erreur lors de la d√©connexion");
        }

        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') window.location.href = 'index.html';
        });

        // Lancement unique de la v√©rification
        checkUser();

        // ==========================================
        // 4. GESTION DES ARTICLES (CRUD)
        // ==========================================
        let allNewsData = [];
        let currentEditId = null;
        let currentEditImageUrl = "";

        document.getElementById('date').valueAsDate = new Date();

        // SAUVEGARDER (CR√âER OU MODIFIER)
        document.getElementById('btnSave').addEventListener('click', async () => {
            const btn = document.getElementById('btnSave');
            const status = document.getElementById('status');
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];

            const titleFR = document.getElementById('title_fr').value;
            const titleEN = document.getElementById('title_en').value;
            const summaryFR = document.getElementById('summary_fr').value;
            const summaryEN = document.getElementById('summary_en').value;
            const contentFR = document.getElementById('content_fr').value;
            const contentEN = document.getElementById('content_en').value;
            const dateVal = document.getElementById('date').value;
            const catFR = document.getElementById('category').value;

            status.style.display = 'none';

            if (!titleFR) {
                alert("Le titre en fran√ßais est obligatoire");
                document.getElementById('title_fr').focus();
                return;
            }

            btn.disabled = true;
            btn.innerHTML = currentEditId ? "<span>üíæ Enregistrement...</span>" : "<span>‚è≥ Publication...</span>";

            try {
                let imageUrl = currentEditImageUrl;

                if (!currentEditId && !file) {
                    imageUrl = "https://placehold.co/800x400?text=Smart+Wise";
                }

                if (file) {
                    const fileExt = file.name.split('.').pop();
                    const cleanName = Date.now() + Math.random().toString(36).substring(7);
                    const fileName = `news_${cleanName}.${fileExt}`;

                    const { error: upErr } = await supabaseClient.storage.from('news-images').upload(fileName, file);
                    if (upErr) throw upErr;

                    const { data: urlData } = supabaseClient.storage.from('news-images').getPublicUrl(fileName);
                    imageUrl = urlData.publicUrl;
                }

                const catTranslations = {
                    "Produits & Services": "Products & Services",
                    "Entreprise": "Corporate",
                    "Technologie": "Technology",
                    "Info Pratique": "Useful Info",
                    "Impact": "Social Impact",
                    "√âv√©nement": "Event"
                };
                const catEN = catTranslations[catFR] || catFR;

                const payload = {
                    date: dateVal,
                    image: imageUrl,
                    title_fr: titleFR,
                    category_fr: catFR,
                    summary_fr: summaryFR,
                    content_fr: contentFR,
                    title_en: titleEN || titleFR,
                    category_en: catEN,
                    summary_en: summaryEN || summaryFR,
                    content_en: contentEN || contentFR
                };

                let error = null;

                if (currentEditId) {
                    const { error: updateErr } = await supabaseClient.from('news').update(payload).eq('id', currentEditId);
                    error = updateErr;
                    status.innerText = "‚úÖ Article modifi√© avec succ√®s !";
                } else {
                    const { error: insertErr } = await supabaseClient.from('news').insert([payload]);
                    error = insertErr;
                    status.innerText = "‚úÖ Article publi√© avec succ√®s !";
                }

                if (error) throw error;

                status.style.background = "#d1fae5";
                status.style.color = "#065f46";
                status.style.display = 'block';

                setTimeout(() => { status.style.display = 'none'; }, 2000);

                resetForm();
                loadNews();

            } catch (e) {
                console.error(e);
                status.innerText = "‚ùå Erreur: " + e.message;
                status.style.background = "#fee2e2";
                status.style.color = "#991b1b";
                status.style.display = 'block';
            } finally {
                btn.disabled = false;
                if (!currentEditId) btn.innerHTML = "<span>üöÄ Publier l'article</span>";
            }
        });

        // LISTER LES ARTICLES
        async function loadNews() {
            const div = document.getElementById('newsList');
            const { data, error } = await supabaseClient.from('news').select('*').order('date', { ascending: false });

            if (error) {
                div.innerHTML = `<p style="color:red">Erreur: ${error.message}</p>`;
                return;
            }

            allNewsData = data || [];

            if (allNewsData.length === 0) {
                div.innerHTML = `<p style="text-align:center; color:#94a3b8;">Aucun article en ligne.</p>`;
                return;
            }

            div.innerHTML = "";
            allNewsData.forEach(item => {
                const dateStr = new Date(item.date).toLocaleDateString('fr-FR');
                div.innerHTML += `
            <div class="news-item">
                <div class="news-content">
                    <img src="${item.image}" alt="Cover" onerror="this.src='https://placehold.co/80?text=IMG'">
                    <div class="news-info">
                        <h3>${item.title_fr}</h3>
                        <div class="news-meta">
                            <span>üìÖ ${dateStr}</span>
                            <span class="badge">${item.category_fr}</span>
                        </div>
                    </div>
                </div>
                <div class="actions">
                    <button class="action-btn edit-btn" onclick="editNews(${item.id})">‚úèÔ∏è Modifier</button>
                    <button class="action-btn delete-btn" onclick="deleteNews(${item.id})">üóëÔ∏è</button>
                </div>
            </div>
        `;
            });
        }

        // FONCTION EDITER
        window.editNews = (id) => {
            const article = allNewsData.find(n => n.id === id);
            if (!article) return;

            currentEditId = id;
            currentEditImageUrl = article.image;

            document.getElementById('formTitle').innerText = "Modifier l'actualit√©";
            document.getElementById('btnSave').innerHTML = "<span>üíæ Mettre √† jour</span>";
            document.getElementById('btnSave').style.background = "#f59e0b";
            document.getElementById('btnCancel').style.display = "flex";

            document.getElementById('date').value = article.date;
            document.getElementById('category').value = article.category_fr;
            document.getElementById('title_fr').value = article.title_fr;
            document.getElementById('summary_fr').value = article.summary_fr || "";
            document.getElementById('content_fr').value = article.content_fr;
            document.getElementById('title_en').value = article.title_en || "";
            document.getElementById('summary_en').value = article.summary_en || "";
            document.getElementById('content_en').value = article.content_en || "";

            const imgPrev = document.getElementById('currentImagePreview');
            imgPrev.src = article.image;
            imgPrev.style.display = 'block';

            // G√©rer l'affichage du placeholder
            document.getElementById('uploadPlaceholder').style.display = 'none';
            document.getElementById('uploadArea').classList.add('has-image');

            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // FONCTION RESET
        function resetForm() {
            currentEditId = null;
            currentEditImageUrl = "";

            document.getElementById('formTitle').innerText = "Publier une Actualit√©";
            document.getElementById('btnSave').innerHTML = "<span>üöÄ Publier l'article</span>";
            document.getElementById('btnSave').style.background = "var(--primary)";
            document.getElementById('btnCancel').style.display = "none";

            // Reset Image Preview
            const preview = document.getElementById('currentImagePreview');
            preview.style.display = 'none';
            preview.src = "";
            document.getElementById('uploadPlaceholder').style.display = 'block';
            document.getElementById('uploadArea').classList.remove('has-image');

            document.querySelectorAll('input[type="text"], textarea').forEach(el => el.value = "");
            document.getElementById('imageFile').value = "";
            document.getElementById('date').valueAsDate = new Date();
        }

        document.getElementById('btnCancel').addEventListener('click', () => { resetForm(); });

        // SUPPRIMER
        window.deleteNews = async (id) => {
            if (confirm("√ätes-vous s√ªr de vouloir supprimer cet article d√©finitivement ?")) {
                const { error } = await supabaseClient.from('news').delete().eq('id', id);
                if (error) alert("Erreur lors de la suppression");
                loadNews();
                if (currentEditId === id) resetForm();
            }
        }

        // GESTION APER√áU IMAGE (FILE READER)
        document.getElementById('imageFile').addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('currentImagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    document.getElementById('uploadPlaceholder').style.display = 'none';
                    document.getElementById('uploadArea').classList.add('has-image');
                }
                reader.readAsDataURL(file);
            }
        });

        // Initialisation
        loadNews();
        // ==========================================
        // GESTION DES COMPTES (POP-UP)
        // ==========================================

        // 1. Ouvrir / Fermer la modale
        function openAccountModal() {
            resetAccView();
            document.getElementById('accountModal').style.display = 'flex';
        }

        function closeAccountModal() {
            document.getElementById('accountModal').style.display = 'none';
        }

        // 2. Navigation dans la modale
        function resetAccView() {
            document.getElementById('accMenu').style.display = 'flex';
            document.getElementById('accAddForm').style.display = 'none';
            document.getElementById('accListPanel').style.display = 'none';
            document.getElementById('newUsername').value = ''; // <--- RAJOUTER ICI
            document.getElementById('newEmail').value = '';
            document.getElementById('newPass').value = '';
        }

        function showAddUser() {
            document.getElementById('accMenu').style.display = 'none';
            document.getElementById('accAddForm').style.display = 'block';
        }

        async function showDeleteUser() {
            document.getElementById('accMenu').style.display = 'none';
            document.getElementById('accListPanel').style.display = 'block';
            loadUsersList();
        }

        // 3. CR√âER UN UTILISATEUR
        async function createUser() {
            const username = document.getElementById('newUsername').value;
            const email = document.getElementById('newEmail').value;
            const password = document.getElementById('newPass').value;
            const role = document.getElementById('newRole').value;

            if (!email || !password || !username) return alert("Email, Nom et mot de passe requis.");

            // Cr√©ation Auth Supabase
            const { data, error } = await supabaseClient.auth.signUp({
                email: email,
                password: password,
                options: {
                    // C'est ici qu'on envoie les m√©tadonn√©es
                    data: {
                        display_name: username, // On envoie le vrai nom saisi
                        role: role
                    }
                }
            });

            if (error) {
                alert("Erreur : " + error.message);
            } else {
                // Note: Si "Confirm Email" est activ√© dans Supabase, l'utilisateur ne pourra pas se connecter tout de suite.
                alert("‚úÖ Utilisateur cr√©√© ! S'il ne peut pas se connecter, v√©rifiez si un mail de confirmation a √©t√© envoy√©.");
                resetAccView();
            }
        }

        // 4. LISTER ET SUPPRIMER (Profils)
        async function loadUsersList() {
            const container = document.getElementById('usersListContainer');
            container.innerHTML = "Chargement...";

            // On r√©cup√®re la liste depuis la table 'profiles'
            const { data: profiles, error } = await supabaseClient
                .from('profiles')
                .select('id, display_name, role, email'); // Assurez-vous d'avoir une colonne email dans profiles ou utilisez display_name

            if (error) {
                container.innerHTML = "Erreur de chargement.";
                return;
            }

            let html = '<ul style="list-style:none; padding:0; margin:0;">';
            profiles.forEach(p => {
                html += `
                <li style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${p.display_name || 'Utilisateur'}</strong> <br>
                        <small style="color:#666">${p.role || 'Editeur'}</small>
                    </div>
                    <button onclick="deleteUserProfile('${p.id}')" style="background:#fee2e2; color:red; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">
                        üóëÔ∏è
                    </button>
                </li>
            `;
            });
            html += '</ul>';
            container.innerHTML = html;
        }

        async function deleteUserProfile(id) {
            if (!confirm("Voulez-vous supprimer ce profil de l'affichage ? (L'acc√®s login devra √™tre coup√© sur Supabase)")) return;

            const { error } = await supabaseClient
                .from('profiles')
                .delete()
                .eq('id', id);

            if (error) {
                alert("Erreur : " + error.message);
            } else {
                loadUsersList(); // Recharger la liste
            }
        }
    </script>
</body>

</html>